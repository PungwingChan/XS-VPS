name: ğŸš€ XServer VPS è‡ªåŠ¨ç»­æœŸ

on:
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:

jobs:
  renewal:
    name: ğŸ”„ æ‰§è¡Œç»­æœŸä»»åŠ¡
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install playwright-stealth || true

      - name: ğŸŒ å®‰è£… Playwright Chromium
        run: |
          python -m playwright install chromium
          sudo apt-get update
          sudo apt-get install -y fonts-ipafont-gothic fonts-ipafont-mincho

      - name: ğŸ–¥ï¸ å¯åŠ¨ Xvfb (Playwright GUI)
        run: |
          sudo apt-get install -y xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: ğŸ¯ è¿è¡Œç»­æœŸè„šæœ¬
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          XSERVER_VPS_ID: ${{ secrets.XSERVER_VPS_ID }}

          CAPTCHA_API_URL: ${{ secrets.CAPTCHA_API_URL }}

          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}

          WAIT_TIMEOUT: '60000'
        run: |
          if [ -n "$PROXY_SERVER" ]; then
            echo "ğŸŒ å·²è®¾ç½®ä»£ç†: $PROXY_SERVER"
          else
            echo "âš ï¸ æœªè®¾ç½®ä»£ç†ï¼Œå°†ç›´æ¥ä½¿ç”¨ GitHub Actions é»˜è®¤ IP"
          fi

          echo "ğŸš€ å¼€å§‹æ‰§è¡Œç»­æœŸä»»åŠ¡..."
          python3 renewal.py

      - name: ğŸ“Š æ˜¾ç¤ºè¿è¡Œç»“æœ
        if: always()
        run: |
          echo "ğŸ“„ README.md:"
          cat README.md
          echo ""
          echo "ğŸ“ renewal.log:"
          tail -n 200 renewal.log

      - name: ğŸ“¦ ä¸Šä¼ è¿è¡Œæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: |
            renewal.log
            cache.json
            *.png

      - name: ğŸ’¾ æäº¤çŠ¶æ€æ›´æ–°
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot ğŸ¤–"
          git add README.md cache.json || true

          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨ç»­æœŸçŠ¶æ€æ›´æ–° [skip ci]"
            git push
          fi
